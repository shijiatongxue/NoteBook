# 模板编译

## 概念

模板编译的主要目标就是生成渲染函数，而渲染函数的作用是每次执行它，它就会使用当前最新的状态生成一份新的vnode，然后使用这个vnode进行渲染。

> 模板 => 渲染函数 => vnode => 渲染

## 将模板编译成渲染函数

将模板编译成渲染函数分为两步，先将模板解析成AST（Abstract Syntax Tree，抽象语法树），然后再使用AST生成渲染函数。

> 在这两个步骤中间，需要做一个优化，那就是遍历一遍AST，给所有的静态节点做一个标记，这样在虚拟DOM更新节点时，如果发现节点有这个标记，就不会重新渲染它。

这三部分内容在模板编译分别抽象出三个模块来实现各自的功能，分别是：

- 解析器
- 优化器
- 代码生成器

### 解析器

解析器将模板解析成AST。

这个AST其实和vnode有点类似，都是使用JavaScript中的对象来表示节点。

### 优化器

优化器的目标是遍历AST，检测出所有静态子树并给其打标记。

```html
<p>
    我是静态节点，我不需要发生变化。
</p>
```

当AST中的静态子树被打上标记后，每次重新渲染时，就不需要为打上标记的静态节点创建新的虚拟节点，而是直接克隆已经存在的虚拟节点。

### 代码生成器

代码生成器是模板编译的最后一步，它的作用是将AST转换成渲染函数中的内容，这个内容可以称为“代码字符串”。

```html
<p title="shi" @click="c">1</p>
```

生成后的代码字符串是：

```js
`with(this){return _c('p',{attrs:{"title":"shi"},on:{"click": c}},[_v("1")])}`
```

格式化后是：

```js
with(this){
    return _c(
        'p',
        {
            attrs:{"title":"shi"},
            on:{"click": c}
        },
        [_v("1")]
    )
}
```

这样一个代码字符串最终导出到外界使用时，会将代码字符串放到渲染函数里。

前面介绍过，渲染函数的作用是创建vnode。渲染函数之所以可以生成vnode，是因为代码字符串中有很多函数调用（例如，上面有两个函数调用\_c和\_v），这些函数是虚拟DOM提供的创建vnode的方法。vnode有很多类型，不同类型对应不同的创建方法，_c可以创建元素类型的vnode，\_v可以创建文本类型的vnode。

---

参考：深入浅出Vue.js





