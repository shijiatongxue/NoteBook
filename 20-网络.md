# 1 浏览器生成消息

- 生成HTTP请求消息
  - 浏览器如何解析网址
  - 请求消息长什么样？
- 向DNS服务器查询Web服务器的IP地址
  - 浏览器查询服务器的IP
- DNS服务器
  - DNS服务器之间的协作
- 委托协议栈发送消息
  - 委托操作系统发送消息

## 1.1 生成HTTP请求消息

### URL
包含协议类型、域名和文件路径等。

### 浏览器如何要解析URL?
根据URL得到协议类型、域名、端口号、路径名等。

### 省略文件名的情况
- https://www.github.com/dir/

一般我们在访问网站的时候不会输入文件名，这时浏览器会根据服务器事先配置好的默认访问文件名，大多数情况下是index.html或default.htm之类的。

- https://www.github.com/
  
有时还会出现访问根目录，情况与上面类似。

- https://www.github.com

当把根目录都省略时，就代表访问根目录下事先设置的默认文件。

- https://www.github.com/what

对于这种末尾没有'/'，一般不推荐使用。服务器会查询有没有这个文件，如果没有这个文件，则把它当作文件夹名处理。

### HTTP的基本思路
解析完URL，浏览器会使用HTTP协议来访问Web服务器。

HTTP请求包括两部分，“对什么”和“进行怎样操作”。

“对什么”：要访问的URI。

“进行什么操作”：

- **GET**：获取URI指定的信息。
- **POST**：从客户端向服务器发送数据。一般是表单。
- HEAD：和GET基本相同，区别在于只返回请求头。
- PUT：替换URI指定的服务器上的文件。或新建文件。
- DELETE：删除文件。
- TRACE：将服务器收到的请求行和头部直接返回给客户端。用于在使用代理的环境中检查改写请求的情况。
- CONNECT：使用代理传输加密消息时使用的方法。
- OPTIONS：用于通知或查询通信选项。

收到请求消息后，Web服务器会对其中的内容进行解析，通过URI和方法来判断“对什么”“进行怎样的操作”，并根据这些要求完成自己的工作，然后将结果放在相应消息中。

响应消息会被发送回客户端，客户端收到之后，浏览器会从消息中读出所需的数据并显示在屏幕上。到这里，HTTP的整个工作就完成了。

### 生成HTTP请求消息
首先，请求消息的第一行称为请求行。

**GET /dir/index.html HTTP/1.1**

第二行开始为消息头。

通用头：适用于请求和响应消息的头字段。
- Date
- Pragma：表示数据是否允许缓存
- Cache-Control：控制缓存的相关信息
- Connection：是否继续保持通信
- Transfer-Enconding
- Via

请求头：用于表示请求消息的附加信息的头字段
- Authorization：身份认证数据
- From：请求发送者的邮件地址
- Host：接收请求的服务器IP和端口号
- Referer
- User-Agent
- Accept-Charset
- Accept-Encoding
- Accept-Language
- If-Match
- If-None-Match
- If-Modified-Since：用于判断客户端缓存数据是否过期
- If-Unmodified-Since：在指定日期之后数据未更新时执行请求
- Range：当需要只获取部分数据而不是全部数据时，可通过这个字段指定要获取的数据范围

响应头：用于表示响应消息的附加信息的头字段
- Location：当前请求URI的据对路径
- Server：服务器程序的名称和版本号等相关信息。
- Accept-Ranges：当希望仅请求部分数据时，服务器会告知客户端是否支持这一功能。
- WWW-Authenticate

实体头：用于表示实体（消息体）的附加信息的头字段
- Allow：表示指定的URI支持的方法
- Content-Type：表示消息体的数据类型，以MIME规格定义的数据类型表示
- Content-Length
- Content-Encoding
- Content-Language：表示消息体的语言。
- Content-Location：表示消息体在服务器上的URI。
- Expires：表示消息体的有效期
- Last-Modified：数据的最后更新日期
- Content-Range：当仅请求部分数据时，表示消息体包含的数据范围
- Etag：在更新操作时，有时候需要基于上一次请求的响应数据来发送一下次请求，在这种情况下，这个字段可以用来提供上次响应与下次请求之间的关联信息。

当用POST方法时，需要将表单中填写的信息写在消息体中。

### 发送请求后会收到响应
响应消息与请求消息的差别只在第一行上。

在响应消息中，第一行的内容为状态码和响应短语，用来表示请求的执行结果是成功还是出错。

状态码概要：

- 1xx：告知请求处理的进度和情况
- 2xx：成功
- 3xx：表示需要进一步操作
- 4xx：客户端错误
- 5xx：服务器错误

返回响应消息后，浏览器会将数据提取出来并显示在屏幕上。当网页包含图片时，会在网页中的相应位置嵌入表示图片文件的标签的控制信息。浏览器遇到图片相关标签时，会在屏幕上留出用来显示图片的空间，然后再次访问Web服务器，按照标签中指定的文件名向Web服务器请求获取相应的图片并显示在预留的空间中。

由于每条消息中只能写一个URI，所以每次只能获取一个文件，如果要获取多个文件，必须对每个文件单独发送一条请求。比如一个网页中包含3张图片，那么获取网页加上获取图片，一共需要向Web服务器发送4条请求。

## 1.2 向DNS服务器查询Web服务器IP地址
### IP地址
生成HTTP消息之后，接下来我们需要委托操作系统将信息发送给Web服务器。

尽管浏览器能够解析网址并生成HTTP消息，但它本身并不具备将消息发送到网络中的功能。

在此之前，我们需要查询网址中服务器域名对象的IP地址。

主机号部分的比特全部为0或者全部为1时代表两种特殊的含义。

- 主机号部分全部为0：代表整个子网
- 主机号部分全部为1：代表向子网上的所有设备发送包

### 域名和IP地址并用的理由
域名最短也要几十个字节，最长甚至可以达到255字节。

路由器的速度是有极限的，而互联网内部流动的数据量已然让路由器疲于应付了，因此我们不应该再采用效率更低的设计。

### Socket库提供查询IP地址的功能
向DNS服务器发出查询，也就是向DNS服务器发送查询消息，并接收服务器返回的响应。换句话说，对于DNS服务器，我们的计算机上一定有相应的DNS客户端，而相当于DNS客户端的部分称为DNS解析器，或者简称解析器。

解析器实际上是一段程序，它包含在操作系统的Socket库中。

Socket库中包含很多用于发送和接收数据的程序组件。

### 通过解析器向DNS服务器发送查询
```c
<应用程序名>(<参数>)
{
    ...
    <内存地址> = gethostbyname("www.github.com");
    ...
    <发送HTTP消息>
    ...
}
```
调用解析器后，解析器会向DNS服务器发送查询消息，然后DNS服务器会相应消息。响应消息中包含查询到的IP，解析器会取出IP，并写入浏览器指定的内存地址中。接下来，浏览器再向Web服务器发送消息时，只要从内存地址取出IP，并将它与HTTP请求消息一起交给操作系统就可以了。

### 解析器内部原理
解析器收到一个域名后，会调用系统内部的协议栈，生成UDP包，然后向DNS服务器发送消息，接收到消息后，把结果返回浏览器。

当DNS服务器收到查询消息后，它会根据消息中的查询内容进行查询。如果要访问的Web服务器已经在DNS服务器上注册，那么这条记录就能够被找到，然后其IP会被写入响应消息并返回给客户端。

## 全世界DNS服务器的协作
### DNS服务器
来自客户端的查询消息：

- 域名
- Class

网络的类型，现在基本都是互联网了。用IN表示。
- 记录

表示域名对应何种类型的记录。A代表IP地址，MX代表邮件服务器。

域名|Class|记录类型|响应数据
-|-|-|-
www.github.com|IN|A|192.0.0.1
github.com|IN|MX|10 mail.github.com
mail.github.com|IN|A|192.0.0.2

当请求类型为A时，直接返回IP；当请求类型为MX时，会在消息保存邮件服务器域名和优先级，然后还有IP。

记录类型除了A和MX两种外，还有：

- PRT：根据IP反查域名
- CNAME：域名别名
- NS：查询DNS服务器IP
- SOA：查询域名属性信息

### 域名的层次结构
根据句点进行划分，越靠右等级越高。

### 寻找相应的DNS服务器并获取IP地址
如何找到我们要访问的Web服务器的信息归哪一台DNS服务器管。

根域名用.表示，在顶级域名后面，如www.github.com.，不过根域名一般被省略不写。根域名保存着顶级域名服务器的信息。由于上级DNS雾浮起保存着所有下级DNS服务器的信息，所以我们可以从根域开始一路往下找到任意一个域的DNS服务器。

除此之外，还要将根域名DNS服务器信息保存在互联网所有DNS服务器中。

因此，客户端只要能找到任意一台DNS服务器，就可以通过它找到根域名DNS服务器，然后再一路找到位于下层某台目标DNS服务器。

分配给根域名DNS服务的IP地址在全世界仅有13个，这些地址几乎不发生变化。只要配置了DNS服务器程序，这些信息就被自动配置好了。

目标DNS服务器的查找过程：

假设我们要找www.github.com这台服务器的相关信息。

- 客户端A首先找到最近的DNS服务器B，也就是客户端配置的DNS服务器地址；
- B首先问根域名服务器，根域说没有，返回com域的DNS服务器地址；
- B询问com域，com域说没有，返回github.com的DNS服务器地址；
- 最后，B询问github.com域，返回www.github.com的Web服务器地址；
- B返回给客户端目标IP。

### 通过缓存加快DNS服务器的响应

DNS服务器有一个缓存功能，可以记住之前查询过的域名。下一次查询就可以快速对查询结果做出响应。

## 1.4 委托协议栈发送消息
### 数据收发操作概览
发送数据也需要调用系统Socket库中的程序组件。

收发数据的操作分为若干个阶段：

1. 创建套接字
2. 将管道连接到服务器端的套接字上
3. 收发数据
4. 断开管道并删除套接字

描述符：应用程序用来识别套接字的机制。

IP和端口号：客户端和服务器之间用来识别对方套接字的机制。

## 总结
在浏览器和Web服务器收发消息过程，实际负责收发消息的是协议栈、网卡驱动和网卡。下一章将对这部分进行探索。